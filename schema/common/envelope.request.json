{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://corpusos.com/schemas/common/envelope.request.json",
  "title": "Corpus Protocol — Request Envelope (v1.0)",
  "description": "Canonical wire-level request envelope used across Graph, LLM, Vector, and Embedding protocols. Matches the '{op, ctx, args}' contract in the Corpus SDK Specification (§4.1.1).",
  "type": "object",
  "required": ["op", "ctx", "args"],
  "additionalProperties": false,
  "properties": {
    "op": {
      "title": "Operation",
      "description": "Canonical operation string: '<component>.<operation>'. Components: graph, llm, vector, embedding. See §4.1.6 for the operation registry.",
      "type": "string",
      "pattern": "^(graph|llm|vector|embedding)\\.[a-z][a-z0-9_]*$",
      "$comment": "For stricter validation, combine with an op registry enum schema when available."
    },
    "ctx": {
      "title": "Operation Context",
      "description": "Context propagated end-to-end (request id, idempotency, deadlines, tracing, tenant, cache hints). See §6.1.",
      "$ref": "https://corpusos.com/schemas/common/operation_context.json"
    },
    "args": {
      "title": "Operation Arguments",
      "description": "Operation-specific arguments payload. Shape depends on 'op'.",
      "type": "object",
      "additionalProperties": true
    },
    "extensions": {
      "title": "Namespaced Extensions (Optional)",
      "description": "Top-level namespaced, vendor-specific extensions. Keys MUST be namespaced (e.g., 'vendor:feature.flag').",
      "type": "object",
      "additionalProperties": true,
      "propertyNames": { "$ref": "#/$defs/namespaced_key" }
    }
  },
  "$defs": {
    "timestamp_ms": {
      "type": "integer",
      "minimum": 0,
      "maximum": 253402300800000,
      "description": "UNIX epoch time in milliseconds (non-negative, ≤ year 9999)."
    },
    "positive_int": {
      "type": "integer",
      "minimum": 1,
      "description": "Positive integer (> 0)."
    },
    "traceparent": {
      "type": "string",
      "description": "W3C Trace Context header (version 00).",
      "pattern": "^00-[0-9a-f]{32}-[0-9a-f]{16}-0[0-9a-f]$"
    },
    "namespaced_key": {
      "type": "string",
      "description": "Namespaced extension key (e.g., 'vendor:feature.flag').",
      "pattern": "^[a-z0-9]+:[a-z0-9_.-]+$"
    },
    "small_label": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-zA-Z0-9_.:-]{1,64}$",
      "description": "Small, low-cardinality label."
    }
  },
  "examples": [
    {
      "op": "vector.query",
      "ctx": {
        "request_id": "req_01HJ2R4S6Z2R2V2Z6V",
        "deadline_ms": 1730935200123,
        "traceparent": "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01",
        "tenant": "acme",
        "cache_scope": "tenant",
        "cache_tags": ["kb", "lang:en"]
      },
      "args": {
        "vector": [0.12, 0.34, 0.56],
        "top_k": 10,
        "namespace": "acme.docs",
        "filter": { "doc_type": "kb" },
        "include_metadata": true,
        "include_vectors": false
      }
    },
    {
      "op": "llm.complete",
      "ctx": {
        "request_id": "req_chat_9b2e",
        "idempotency_key": "idem_9b2e_f7",
        "deadline_ms": 1730935200123,
        "traceparent": "00-aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa-bbbbbbbbbbbbbbbb-01",
        "tenant": "acme",
        "attrs": { "user": "u_123", "feature": "kb" }
      },
      "args": {
        "messages": [
          { "role": "system", "content": "You are concise." },
          { "role": "user", "content": "Summarize this document list..." }
        ],
        "model": "gpt-4.1-mini",
        "temperature": 0.2,
        "max_tokens": 256
      }
    },
    {
      "op": "graph.query",
      "ctx": {
        "request_id": "gq_123",
        "deadline_ms": 1730935200123
      },
      "args": {
        "dialect": "cypher",
        "text": "MATCH (n) RETURN n LIMIT 10",
        "params": null
      }
    },
    {
      "op": "embedding.embed_batch",
      "ctx": {
        "request_id": "emb_abc",
        "deadline_ms": 1730935200123,
        "tenant": "acme"
      },
      "args": {
        "texts": ["alpha", "beta", "gamma"],
        "model": "example-embed-1",
        "normalize": true,
        "truncate": true
      }
    }
  ],
  "$comment": "This schema defines the generic Corpus Protocol request envelope shape: { op, ctx, args, extensions }. Component-specific envelopes (graph/llm/vector/embedding) bind concrete op values to concrete args schemas."
}
